<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Itinerary</title>
    <!-- <link rel="stylesheet" href="../styles/register.css"> Link your CSS file here -->
    <style>
        /* Optional: Adjust styles for the map container */
        #map {
            height: 300px; /* Set a height for the map */
            width: 100%; /* Make the map full width */
            margin-top: 10px;
        }
        /* Style for the search boxes */
        #pac-input-pickup, #pac-input-dropoff {
            margin-top: 10px;
            width: 300px;
            height: 30px;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="title">Create Itinerary</div>
        <form id="createItineraryForm">
            <div class="field">
                <input type="text" id="creator" name="Creator" required>
                <label for="creator">Creator</label>
            </div>

            <div class="field">
                <input type="text" id="name" name="Name" required>
                <label for="name">Name</label>
            </div>

            <div class="field">
                <label>Activities</label>
                <div id="activitiesContainer"></div> <!-- Checkbox container for activities -->
            </div>

            <div class="field">
                <label>Locations to Visit</label>
                <div id="locationsContainer"></div> <!-- Checkbox container for locations -->
            </div>

            <div class="field">
                <input type="text" id="timeline" name="TimeLine">
                <label for="timeline">TimeLine</label>
            </div>

            <div class="field">
                <input type="text" id="language" name="Language" required>
                <label for="language">Language</label>
            </div>

            <div class="field">
                <input type="number" id="price" name="Price" required>
                <label for="price">Price</label>
            </div>

            <div class="field">
                <input type="text" id="availableDates" name="AvailableDates" required>
                <label for="availableDates">Available Dates</label>
            </div>

            <!-- Pick Up Location -->
            <div class="field">
                <input type="text" id="pac-input-pickup" placeholder="Search for Pick Up Location" required>
                <input type="hidden" id="pickUpLocation" name="PickUpLocation">
                <label for="pickUpLocation">Pick Up Location</label>
            </div>

            <!-- Drop Off Location -->
            <div class="field">
                <input type="text" id="pac-input-dropoff" placeholder="Search for Drop Off Location" required>
                <input type="hidden" id="dropOffLocation" name="DropOffLocation">
                <label for="dropOffLocation">Drop Off Location</label>
                <div id="map"></div> <!-- Google Maps container -->
            </div>

            <div class="field">
                <input type="submit" value="Create Itinerary">
            </div>
        </form>
    </div>

    <script>
        let map;
        let pickupMarker, dropoffMarker;

        function initMap() {
            const defaultLocation = { lat: -34.397, lng: 150.644 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 8,
            });

            const pickupInput = document.getElementById("pac-input-pickup");
            const dropoffInput = document.getElementById("pac-input-dropoff");

            const pickupSearchBox = new google.maps.places.SearchBox(pickupInput);
            const dropoffSearchBox = new google.maps.places.SearchBox(dropoffInput);

            map.addListener("bounds_changed", () => {
                pickupSearchBox.setBounds(map.getBounds());
                dropoffSearchBox.setBounds(map.getBounds());
            });

            pickupSearchBox.addListener("places_changed", () => {
                const places = pickupSearchBox.getPlaces();
                if (places.length === 0) return;

                if (pickupMarker) pickupMarker.setMap(null);
                const place = places[0];
                if (place.geometry && place.geometry.location) {
                    pickupMarker = new google.maps.Marker({
                        map: map,
                        position: place.geometry.location,
                    });
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    document.getElementById("pickUpLocation").value = `${place.geometry.location.lat()}, ${place.geometry.location.lng()}`;
                }
            });

            dropoffSearchBox.addListener("places_changed", () => {
                const places = dropoffSearchBox.getPlaces();
                if (places.length === 0) return;

                if (dropoffMarker) dropoffMarker.setMap(null);
                const place = places[0];
                if (place.geometry && place.geometry.location) {
                    dropoffMarker = new google.maps.Marker({
                        map: map,
                        position: place.geometry.location,
                    });
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    document.getElementById("dropOffLocation").value = `${place.geometry.location.lat()}, ${place.geometry.location.lng()}`;
                }
            });
        }

        // Fetch and display activities on page load
        async function fetchActivities() {
            try {
                const response = await fetch("http://localhost:8000/viewActivities"); // Endpoint to fetch activities
                if (response.ok) {
                    const activities = await response.json();
                    populateActivitiesCheckboxes(activities);
                } else {
                    console.error("Failed to fetch activities");
                }
            } catch (error) {
                console.error("Error fetching activities:", error);
            }
        }

        // Populate the checkbox container with activities
        function populateActivitiesCheckboxes(activities) {
            const activitiesContainer = document.getElementById("activitiesContainer");
            activities.forEach(activity => {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.name = "Activities"; // Same name for all activities
                checkbox.value = activity.name; // Assuming each activity has a 'name' field
                const label = document.createElement("label");
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(activity.name)); // Display activity name
                activitiesContainer.appendChild(label);
                activitiesContainer.appendChild(document.createElement("br")); // New line for better layout
            });
        }

        // Fetch and display locations on page load
        async function fetchPlaces() {
            try {
                const response = await fetch("http://localhost:8000/readPlaces"); // Endpoint to fetch places
                if (response.ok) {
                    const places = await response.json();
                    populatePlacesCheckboxes(places);
                } else {
                    console.error("Failed to fetch places");
                }
            } catch (error) {
                console.error("Error fetching places:", error);
            }
        }

        // Populate the checkbox container with locations
        function populatePlacesCheckboxes(places) {
            const locationsContainer = document.getElementById("locationsContainer");
            places.forEach(place => {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.name = "LocationsToVisit"; // Same name for all locations
                checkbox.value = place.name; // Assuming each place has a 'name' field
                const label = document.createElement("label");
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(place.name)); // Display place name
                locationsContainer.appendChild(label);
                locationsContainer.appendChild(document.createElement("br")); // New line for better layout
            });
        }

        const form = document.getElementById("createItineraryForm");

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData(form);

            // Collect selected activities
            const selectedActivities = Array.from(form.querySelectorAll('input[name="Activities"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Collect selected locations
            const selectedLocations = Array.from(form.querySelectorAll('input[name="LocationsToVisit"]:checked'))
                .map(checkbox => checkbox.value);

            console.log('Form Data:', {
                Creator: formData.get("Creator"),
                Name: formData.get("Name"),
                Activities: selectedActivities,
                LocationsToVisit: selectedLocations, // Use the selected locations
                TimeLine: formData.get("TimeLine"),
                Language: formData.get("Language"),
                Price: formData.get("Price"),
                AvailableDates: formData.get("AvailableDates"),
                PickUpLocation: formData.get("PickUpLocation"),
                DropOffLocation: formData.get("DropOffLocation"),
            });

            if (!formData.get("PickUpLocation") || !formData.get("DropOffLocation")) {
                alert("Please select valid Pick Up and Drop Off locations.");
                return;
            }

            const data = {
                Creator: formData.get("Creator"),
                Name: formData.get("Name"),
                Activities: selectedActivities,
                LocationsToVisit: selectedLocations, // Include selected locations
                TimeLine: formData.get("TimeLine"),
                Language: formData.get("Language"),
                Price: formData.get("Price"),
                AvailableDates: formData.get("AvailableDates"),
                PickUpLocation: formData.get("PickUpLocation"),
                DropOffLocation: formData.get("DropOffLocation"),
            };

            try {
                const response = await fetch("http://localhost:8000/createItinerary", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    alert("Itinerary created successfully!");
                    form.reset(); // Clear form
                } else {
                    const errorResponse = await response.json();
                    console.error("Server error:", errorResponse);
                    alert(`Error creating itinerary: ${errorResponse.message}`);
                }
            } catch (error) {
                console.error("Network or JavaScript error:", error);
                alert("Error creating itinerary. Please check console logs.");
            }
        });

        // Call fetchActivities and fetchPlaces on page load
        window.onload = function () {
            fetchActivities(); // Existing function to fetch activities
            fetchPlaces(); // New function to fetch locations
            initMap(); // Ensure your map initializes as well
        };

    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUGuPbWdSWysqduevM3zHurxQAf8cFyTY&libraries=places&callback=initMap"></script>
</body>
</html>
