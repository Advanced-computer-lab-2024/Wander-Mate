<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaints List</title>
    
    <!-- Link to the CSS file (adjust the path as needed) -->
    <link rel="stylesheet" href="../styles/register.css">

    <script>
        async function fetchComplaints() {
    try {
        const response = await fetch('http://localhost:8000/viewAllComplaints');
        const data = await response.json();
        console.log(data); // Debugging: Log the entire response to confirm structure

        if (response.ok) {
            document.getElementById('message').textContent = '';
            const complaintsContainer = document.getElementById('complaints');
            complaintsContainer.innerHTML = '<h2>Complaints</h2>';

            data.complaints.forEach(complaint => {
                console.log(complaint); // Debugging: Log each complaint to confirm ID
                const complaintId = complaint._id || complaint.id || complaint.complaintId; // Adjust based on actual property

                complaintsContainer.innerHTML += `
                    <div class="complaint">
                        <h3>${complaint.Title}</h3>
                        <p><strong>Description:</strong> ${complaint.Body}</p>
                        <p><strong>Date:</strong> ${new Date(complaint.Date).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> ${complaint.Status}</p>

                        <!-- Reply Section -->
                        <div class="reply-section">
                            <textarea id="reply-${complaintId}" placeholder="Type your reply here..."></textarea>
                            <button onclick="sendReply('${complaintId}')">Send Reply</button>
                        </div>
                    </div>`;
            });
        } else {
            document.getElementById('message').textContent = data.message;
        }
    } catch (error) {
        console.error('Error fetching complaints:', error);
        document.getElementById('message').textContent = 'An error occurred while fetching complaints.';
    }
}

// Function to send a reply for a specific complaint
async function sendReply(complaintId) {
    console.log("Sending reply for complaint ID:", complaintId); // Debugging
    const replyMessage = document.getElementById(`reply-${complaintId}`).value;

    if (!replyMessage) {
        alert("Please enter a reply message.");
        return;
    }

    try {
        const response = await fetch(`http://localhost:8000/complaints/${complaintId}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Body: replyMessage }) // Adjusted to match backend expected structure
        });

        if (response.ok) {
            alert("Reply sent successfully!");
            document.getElementById(`reply-${complaintId}`).value = ''; // Clear the text area
        } else {
            alert("Failed to send reply. Please try again.");
        }
    } catch (error) {
        console.error("Error sending reply:", error);
        alert("An error occurred while sending the reply.");
    }
}


        // Fetch complaints when the page loads
        window.onload = fetchComplaints;
    </script>
</head>
<body>
    <div class="wrapper">
        <div class="container">
            <h1>Complaints List</h1>
            <div id="message" class="error"></div>
            <div id="complaints"></div>
        </div>
    </div>
</body>
</html>
